---
import '../styles/global.css';
import { getTranslations } from '../i18n';

export interface Props {
  title: string;
  description?: string;
}

const { title, description = "Sportigio - Komunikacja klubu w 1 prostej aplikacji" } = Astro.props;

// Detect language from URL prefix
const pathname = Astro.url.pathname;
const currentLang = pathname.startsWith('/en')
  ? 'en'
  : pathname.startsWith('/es')
  ? 'es'
  : pathname.startsWith('/de')
  ? 'de'
  : 'pl';

// CookieConsent translations sourced from i18n files
const trPL = getTranslations('pl');
const trEN = getTranslations('en');
const trES = getTranslations('es');
const trDE = getTranslations('de');
const ccTranslations = {
  pl: trPL.cookies,
  en: trEN.cookies,
  es: trES.cookies,
  de: trDE.cookies,
};

// IDs for analytics/marketing (from env)
const GA_ID = import.meta.env.PUBLIC_GA_ID || '';
const CLARITY_ID = import.meta.env.PUBLIC_CLARITY_ID || '';
const META_PIXEL_ID = import.meta.env.PUBLIC_META_PIXEL_ID || '';
---

<!DOCTYPE html>
<html lang={currentLang} class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="description" content={description} />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex, nofollow" />
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <meta name="generator" content={Astro.generator} />
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Poppins:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <!-- Material Symbols (Google Fonts) for icons -->
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,400,0,0" rel="stylesheet" />
  
  <!-- CookieConsent (self-hosted) -->
  <link rel="stylesheet" href="/vendor/cookieconsent/cookieconsent.css">
  <script defer src="/vendor/cookieconsent/cookieconsent.js"></script>
  <!-- Pass translations to client using define:vars -->
  <script is:inline define:vars={{ ccTranslations, currentLang }}>
    window.__CC_TRANSLATIONS__ = ccTranslations;
    window.__CC_LANG__ = currentLang;
  </script>
  
  <style>
    /* CookieConsent theming to match Sportigio brand */
    :root {
      --cc-bg: #ffffff;
      --cc-text: #0B2360; /* primary */
      --cc-btn-primary-bg: #0B2360;
      --cc-btn-primary-text: #ffffff;
      --cc-btn-secondary-bg: #f1f5f9;
      --cc-btn-secondary-text: #0B2360;
      --cc-toggle-on-bg: #01DFEC; /* secondary */
      --cc-toggle-off-bg: #cbd5e1;
      --cc-toggle-on-knob-bg: #0B2360;
      --cc-toggle-off-knob-bg: #ffffff;
      --cc-cookie-category-block-bg: #f8fafc;
    }
  </style>
  
  <script>
    // Initialize CookieConsent after load
    window.addEventListener('load', function () {
      try {
        var translations = window.__CC_TRANSLATIONS__ || {};
        var ccDefaultLang = window.__CC_LANG__ || document.documentElement.lang || 'pl';
        if (typeof CookieConsent === 'undefined' || !CookieConsent.run) return;

        CookieConsent.run({
          autoShow: true,
          cookie: {
            name: 'sportigio_cc',
            expiresAfterDays: 180,
          },
          guiOptions: {
            consentModal: {
              layout: 'box',
              position: 'bottom left',
              equalWeightButtons: true,
              flipButtons: false,
            },
            preferencesModal: {
              layout: 'box',
              position: 'right',
              equalWeightButtons: true,
              flipButtons: false,
            }
          },
          categories: {
            necessary: { enabled: true, readOnly: true },
            analytics: {
              enabled: false,
              autoClear: {
                cookies: [
                  { name: /^(_ga|_gid|_gat.*)$/ },
                  { name: /^_clck$/ },
                  { name: /^_clsk$/ },
                ],
              },
            },
            marketing: {
              enabled: false,
              autoClear: {
                cookies: [ { name: /^_fbp$/ } ],
              },
            },
          },
          language: {
            default: ccDefaultLang,
            translations: translations,
          },
        });
      } catch (e) {
        console.warn('CookieConsent init error', e);
      }
    });
  </script>
  
  <title>{title}</title>
</head>
<body class="font-inter text-primary bg-gray100 antialiased">
  <slot />
  
  {GA_ID && (
    <script type="text/plain" data-category="analytics" is:inline>
      {`var GA_ID='${GA_ID}'; if(GA_ID){
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);} 
        gtag('js', new Date());
        gtag('config', GA_ID);
        var s=document.createElement('script'); s.async=1;
        s.src='https://www.googletagmanager.com/gtag/js?id='+GA_ID;
        document.head.appendChild(s);
      }`}
    </script>
  )}

  {CLARITY_ID && (
    <script type="text/plain" data-category="analytics" is:inline>
      {`(function(c,l,a,r,i,t,y){
        if(!'${CLARITY_ID}') return;
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src='https://www.clarity.ms/tag/${CLARITY_ID}';
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
      })(window, document, 'clarity', 'script');`}
    </script>
  )}

  {META_PIXEL_ID && (
    <script type="text/plain" data-category="marketing" is:inline>
      {`!function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
      n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
      n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
      t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window, document,'script',
      'https://connect.facebook.net/en_US/fbevents.js');
      fbq('init', '${META_PIXEL_ID}');
      fbq('track', 'PageView');`}
    </script>
  )}
</body>
</html> 
