---
import {
  createTranslator,
  defaultLanguage,
  getTranslations,
  type Language,
} from "../i18n";

interface Review {
  text: string;
  author: string;
  role?: string;
  avatar?: string;
  avatarAlt?: string;
}

export interface Props {
  id?: string;
  lang?: Language;
}

const { id = "testimonials", lang = defaultLanguage } = Astro.props as Props;

const t = createTranslator(lang);
const translations = getTranslations(lang) as any;
const fallbackTranslations =
  lang === defaultLanguage
    ? translations
    : (getTranslations(defaultLanguage) as any);

const normalizeReviews = (value: any): Review[] => {
  const source = Array.isArray(value)
    ? value
    : value && typeof value === "object"
      ? Object.values(value)
      : [];

  return source
    .map((item: any) => {
      const text = item?.text ? String(item.text) : "";
      const author = item?.author ? String(item.author) : "";
      if (!text || !author) return null;
      const role = item?.role ? String(item.role) : undefined;
      const avatar = item?.avatar ? String(item.avatar) : undefined;
      const avatarAlt = item?.avatarAlt ? String(item.avatarAlt) : author;
      return { text, author, role, avatar, avatarAlt } satisfies Review;
    })
    .filter(Boolean) as Review[];
};

const reviewCandidates = [
  normalizeReviews(translations?.testimonials?.reviews),
  normalizeReviews(fallbackTranslations?.testimonials?.reviews),
];

const fallbackReviews: Review[] = [
  {
    text:
      lang === defaultLanguage
        ? "Nie sądziłam, że aktualizacja strony klubu może być tak łatwa jak prowadzenie Facebooka. Panel admina jest bardzo intuicyjny"
        : "I never thought updating the club website could be as easy as running Facebook. The admin panel is incredibly intuitive.",
    author: "Barbara Lewandowska-Paluch",
    role: "Trefl Sopot",
    avatar: "/teams/trefl.avif",
    avatarAlt: "Trefl Sopot",
  },
  {
    text:
      lang === defaultLanguage
        ? "Zaczęliśmy od odświeżenia klubowej strony www. I tu pierwsze WOW wśród odbiorców. Okazało się, że dla wielu MTS Żory stał się marką PREMIUM, tylko dlatego że został ładnie opakowany."
        : "We started by refreshing the club website and instantly got a WOW from supporters. For many people MTS Żory suddenly felt like a PREMIUM brand just because of the new presentation.",
    author: "Daniel Asztemborski",
    role: "MTS Żory",
    avatar: "/teams/mts-zory.avif",
    avatarAlt: "MTS Żory",
  },
  {
    text:
      lang === defaultLanguage
        ? "Nie mieliśmy wcześniej strony internetowej, bo myśleliśmy, że to droga i czasochłonna inwestycja. Teraz mamy w pełni profesjonalne narzędzie."
        : "We didn’t have a website before because we assumed it would be expensive and time-consuming. Now we have a fully professional tool.",
    author: "Mariusz Ratajczak",
    role: "KKS Astra Krotoszyn",
    avatar: "/teams/astra-krotoszyn.avif",
    avatarAlt: "KKS Astra Krotoszyn",
  },
];

const reviews =
  reviewCandidates.find((list) => list.length > 0) ?? fallbackReviews;

const ctaText =
  t("testimonials.cta_text") !== "testimonials.cta_text"
    ? t("testimonials.cta_text")
    : lang === defaultLanguage
      ? "Dołącz do ponad 100+ klubów"
      : "Join over 100+ satisfied clubs";
---

<section {id} class="py-16 bg-white overflow-hidden">
  <div class="container mx-auto px-4">
    <div class="text-center mb-12">
      <h2
        class="text-2xl lg:text-3xl font-black font-poppins text-gray-900 mb-4"
      >
        {t("testimonials.title")}
      </h2>
      <p class="text-lg text-gray-600 mb-8">{t("testimonials.subtitle")}</p>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      {
        reviews.map((review) => (
          <div class="testimonial-card bg-white rounded-xl p-6 shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-2 border border-gray-100 flex flex-col h-full">
            <p class="text-gray-900 italic text-base md:text-lg mb-4 leading-relaxed font-semibold text-center">
              {review.text}
            </p>
            <div class="mt-auto flex items-center">
              {review.avatar && (
                <img
                  src={review.avatar}
                  alt={review.avatarAlt ?? review.role ?? review.author}
                  class="w-10 h-10 object-contain mr-3 border border-gray-100 shadow-sm bg-white p-1"
                />
              )}
              <div>
                <p class="text-gray-700 font-semibold text-sm">
                  {review.author}
                </p>
                {review.role && (
                  <p class="text-gray-500 text-xs">{review.role}</p>
                )}
              </div>
            </div>
          </div>
        ))
      }
    </div>

    <div class="text-center mt-12">
      <p class="text-gray-600 mb-6">{ctaText}</p>
      <a
        href="https://sportig.io/join"
        class="btn-style-1 px-8 py-3 text-white font-semibold rounded-lg hover:scale-105 transition-all duration-200 shadow-lg"
      >
        {t("common.try_free")}
      </a>
    </div>
  </div>
</section>

<style>
  .testimonial-card:hover {
    transform: translateY(-8px) scale(1.02);
  }
</style>
