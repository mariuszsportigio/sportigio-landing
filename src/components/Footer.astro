---
import {
  type Language,
  defaultLanguage,
  createTranslator,
  getTranslations,
} from "../i18n";

export interface Props {
  lang?: Language;
}

const { lang = defaultLanguage } = Astro.props as Props;
const t = createTranslator(lang);

const currentYear = String(new Date().getFullYear());
const rawCopyright = t("footer.copyright");
const copyright =
  rawCopyright && rawCopyright !== "footer.copyright"
    ? rawCopyright.replace("{year}", currentYear)
    : lang === "pl"
      ? `© ${currentYear} Sportigio. Wszystkie prawa zastrzeżone.`
      : `© ${currentYear} Sportigio. All rights reserved.`;

type MegaItem = { label: string; href: string; description?: string };
type MegaGroup = { title: string; items: MegaItem[] };

const raw = getTranslations(lang) as any;
const productGroups: MegaGroup[] = (raw?.navigation?.mega?.menus?.product
  ?.groups || []) as MegaGroup[];
// V1: only show core product links in footer; hide kitchen/resources entirely
const allowedProductHrefs = new Set([
  "/strona",
  "/bilety-online",
  "/sklep-sportigio",
  "/sklep-wlasny",
]);
const productGroupsV1: MegaGroup[] = productGroups
  .map((g) => ({
    title: g.title,
    items: (g.items || []).filter((it) => allowedProductHrefs.has(it.href)),
  }))
  .filter((g) => g.items.length > 0);
---

<footer class="bg-gray-900 text-white">
  <div class="max-w-5xl mx-auto px-6">
    <!-- Main Footer Content -->
    <div class="py-16">
      <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-8">
        <!-- Company Info -->
        <div class="col-span-2 lg:col-span-2">
          <div class="flex items-center space-x-2 mb-4">
            <img
              src="/sportigio-logo-white.png"
              alt="Sportigio"
              class="h-8 w-auto"
            />
          </div>

          <p class="text-gray-400 mb-6 leading-relaxed max-w-md">
            {
              t("footer.company_blurb") ||
                (lang === "pl"
                  ? "Platforma zarządzania klubami sportowymi nowej generacji. Uprość komunikację, automatyzuj procesy i skup się na tym, co najważniejsze."
                  : "Next‑generation sports club management platform. Simplify communication, automate processes, and focus on what matters most.")
            }
          </p>

          <!-- Social Media: X, Instagram, Facebook, LinkedIn -->
          <div class="flex space-x-4">
            <!-- X (Twitter) using asset from /public, colorized to match (white) -->
            <a
              href="https://x.com/sportigio"
              aria-label="Sportigio on X"
              target="_blank"
              rel="noopener noreferrer"
              class="w-10 h-10 bg-gray-800 rounded-lg flex items-center justify-center hover:bg-primary transition-colors duration-300"
            >
              <img
                src="/X-logo.png"
                alt="X"
                class="w-7 h-7 object-contain"
                loading="lazy"
                style="filter: brightness(0) invert(1);"
              />
            </a>

            <!-- Instagram using asset from /public, colorized to match (white) -->
            <a
              href="https://www.instagram.com/sportigio.polska/"
              aria-label="Sportigio on Instagram"
              target="_blank"
              rel="noopener noreferrer"
              class="w-10 h-10 bg-gray-800 rounded-lg flex items-center justify-center hover:bg-primary transition-colors duration-300"
            >
              <img
                src="/instagram-logo.png"
                alt="Instagram"
                class="w-7 h-7 object-contain"
                loading="lazy"
                style="filter: brightness(0) invert(1);"
              />
            </a>

            <!-- Facebook using asset from /public, colorized to match (white) -->
            <a
              href="https://www.facebook.com/sportigio.polska"
              aria-label="Sportigio on Facebook"
              target="_blank"
              rel="noopener noreferrer"
              class="w-10 h-10 bg-gray-800 rounded-lg flex items-center justify-center hover:bg-primary transition-colors duration-300"
            >
              <img
                src="/facebook-logo.png"
                alt="Facebook"
                class="w-6 h-6 object-contain"
                loading="lazy"
                style="filter: brightness(0) invert(1);"
              />
            </a>

            <!-- LinkedIn -->
            <a
              href="https://www.linkedin.com/company/sportigio/posts/?feedView=all"
              aria-label="Sportigio on LinkedIn"
              target="_blank"
              rel="noopener noreferrer"
              class="w-10 h-10 bg-gray-800 rounded-lg flex items-center justify-center hover:bg-primary transition-colors duration-300"
            >
              <svg
                class="w-5 h-5"
                fill="currentColor"
                viewBox="0 0 24 24"
                aria-hidden="true"
              >
                <path
                  d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"
                ></path>
              </svg>
            </a>
          </div>
        </div>

        <!-- Product Links (from Navbar mega menu) -->
        <div>
          <h3 class="text-lg font-semibold mb-4">
            {t("navigation.product") || (lang === "pl" ? "Produkt" : "Product")}
          </h3>
          {
            productGroupsV1 && productGroupsV1.length > 0 ? (
              <div class="space-y-5">
                {productGroupsV1.map((group) => (
                  <div>
                    <h4 class="text-xs font-semibold text-gray-300 uppercase tracking-widest mb-2">
                      {group.title}
                    </h4>
                    <ul class="space-y-2">
                      {group.items.map((item) => (
                        <li>
                          <a
                            href={item.href || "#"}
                            class="text-gray-400 hover:text-white transition-colors duration-200"
                          >
                            {item.label}
                          </a>
                        </li>
                      ))}
                    </ul>
                  </div>
                ))}
              </div>
            ) : (
              <ul class="space-y-3">
                <li>
                  <a
                    href="/pricing"
                    class="text-gray-400 hover:text-white transition-colors duration-200"
                  >
                    {t("navigation.pricing") ||
                      (lang === "pl" ? "Cennik" : "Pricing")}
                  </a>
                </li>
                <li>
                  <a
                    href="/blog"
                    class="text-gray-400 hover:text-white transition-colors duration-200"
                  >
                    {t("navigation.blog") || "Blog"}
                  </a>
                </li>
              </ul>
            )
          }
        </div>

        <!-- Solutions/Resources hidden for v1 -->

        <!-- Quick Nav Links -->
        <div>
          <h3 class="text-lg font-semibold mb-4">
            {
              t("navigation.menu") ||
                (lang === "pl" ? "Nawigacja" : "Navigation")
            }
          </h3>
          <ul class="space-y-2">
            <li>
              <a
                href="/pricing"
                class="text-gray-400 hover:text-white transition-colors duration-200"
                >{
                  t("navigation.pricing") ||
                    (lang === "pl" ? "Cennik" : "Pricing")
                }</a
              >
            </li>
            <li>
              <a
                href="/blog"
                class="text-gray-400 hover:text-white transition-colors duration-200"
                >{t("navigation.blog") || "Blog"}</a
              >
            </li>
          </ul>
        </div>
      </div>

      <!-- Newsletter Section -->
      <div class="mt-16 pt-16 border-t border-gray-800">
        <div class="grid md:grid-cols-2 gap-8 items-center">
          <div>
            <h3 class="text-2xl font-bold font-poppins mb-4">
              {
                t("footer.newsletter.title") ||
                  (lang === "pl" ? "Zostań na bieżąco" : "Stay up to date")
              }
            </h3>
            <p class="text-gray-400">
              {
                t("footer.newsletter.desc") ||
                  (lang === "pl"
                    ? "Otrzymuj najnowsze informacje o funkcjach, wskazówki i artykuły o zarządzaniu klubami sportowymi."
                    : "Get the latest feature updates, tips and articles about sports club management.")
              }
            </p>
          </div>

          <div
            class="flex flex-col sm:flex-row gap-4"
            data-newsletter
            data-invalid={lang === "pl"
              ? "Nieprawidłowy e‑mail"
              : "Invalid email"}
            data-success={lang === "pl"
              ? "Dziękujemy! Sprawdź skrzynkę."
              : "Thanks! Please check your inbox."}
            data-failure={lang === "pl"
              ? "Nie udało się zapisać."
              : "Subscription failed."}
          >
            <input
              id="newsletter-email"
              type="email"
              placeholder={t("footer.newsletter.placeholder") ||
                (lang === "pl" ? "Twój adres e‑mail" : "Your email address")}
              class="flex-1 px-4 py-3 bg-gray-800 text-white rounded-lg border border-gray-700 focus:outline-none focus:border-[#0B2360] transition-colors duration-200"
              aria-label={lang === "pl" ? "Adres e‑mail" : "Email address"}
            />

            <button
              id="newsletter-submit"
              class="bg-secondary px-6 py-3 text-primary font-semibold rounded-lg hover:scale-105 transition-all duration-200 shadow-lg"
              data-label-default={t("footer.newsletter.cta") ||
                (lang === "pl" ? "Zapisz się" : "Subscribe")}
              data-label-loading={lang === "pl"
                ? "Zapisywanie…"
                : "Subscribing…"}
            >
              {
                t("footer.newsletter.cta") ||
                  (lang === "pl" ? "Zapisz się" : "Subscribe")
              }
            </button>
          </div>
          <p
            id="newsletter-message"
            class="mt-2 text-sm text-gray-400 min-h-[1rem]"
          >
          </p>
        </div>
      </div>
    </div>

    <!-- Bottom Footer -->
    <div class="py-8 border-t border-gray-800">
      <div class="flex flex-col md:flex-row justify-between items-center gap-4">
        <div class="text-gray-400 text-sm">
          {copyright}
        </div>

        <div
          class="grid grid-cols-2 gap-3 text-sm md:flex md:flex-wrap md:gap-6"
        >
          <a
            href="#"
            class="text-gray-400 hover:text-white transition-colors duration-200"
            >{
              t("footer.legal.privacy") ||
                (lang === "pl" ? "Polityka prywatności" : "Privacy Policy")
            }</a
          >
          <a
            href="#"
            class="text-gray-400 hover:text-white transition-colors duration-200"
            >{
              t("footer.legal.terms") || (lang === "pl" ? "Regulamin" : "Terms")
            }</a
          >
          <a
            href="#"
            data-cc-open
            class="text-gray-400 hover:text-white transition-colors duration-200"
            >{
              t("footer.legal.cookies") ||
                (lang === "pl" ? "Pliki cookie" : "Cookies")
            }</a
          >
          <a
            href="#"
            class="text-gray-400 hover:text-white transition-colors duration-200"
            >{t("footer.legal.rodo") || (lang === "pl" ? "RODO" : "GDPR")}</a
          >
        </div>
      </div>
    </div>
  </div>
</footer>

<script is:inline>
  (() => {
    const url =
      "https://dfdu1vke3eg77.cloudfront.net/spaces/95/uploads/HzkZ1wbPB2KpSpmj37Y3NzjXR5jP7xirGRsz2lpN.pdf";
    const run = () => {
      try {
        // Newsletter handler
        const scope = document.querySelector("[data-newsletter]");
        const input = document.getElementById("newsletter-email");
        const button = document.getElementById("newsletter-submit");
        const msg = document.getElementById("newsletter-message");
        const setMessage = (text, ok = false) => {
          if (!msg) return;
          msg.textContent = text || "";
          msg.classList.remove("text-red-400", "text-green-400");
          msg.classList.add(ok ? "text-green-400" : "text-red-400");
        };
        const emailRegex = /.+@.+\..+/;
        if (
          scope &&
          input instanceof HTMLInputElement &&
          button instanceof HTMLButtonElement
        ) {
          const defaultLabel =
            button.getAttribute("data-label-default") ||
            button.textContent ||
            "";
          const loadingLabel = button.getAttribute("data-label-loading") || "…";
          const submit = async () => {
            const email = (input.value || "").trim();
            setMessage("");
            if (!emailRegex.test(email)) {
              setMessage(
                scope?.getAttribute("data-invalid") || "Invalid email",
              );
              return;
            }
            button.disabled = true;
            button.textContent = loadingLabel;
            try {
              const res = await fetch("/api/subscribe", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ email }),
              });
              if (res.ok) {
                setMessage(
                  scope?.getAttribute("data-success") ||
                    "Thanks! Please check your inbox.",
                  true,
                );
                input.value = "";
              } else {
                const data = await res.json().catch(() => ({}));
                const detail = (data && (data.message || data.error)) || "";
                setMessage(
                  (scope?.getAttribute("data-failure") ||
                    "Subscription failed.") + (detail ? ` (${detail})` : ""),
                );
              }
            } catch (e) {
              setMessage(
                scope?.getAttribute("data-failure") || "Subscription failed.",
              );
            } finally {
              button.disabled = false;
              button.textContent = defaultLabel;
            }
          };
          button.addEventListener("click", submit);
          input.addEventListener("keydown", (e) => {
            if (e.key === "Enter") submit();
          });
        }
        const anchors = Array.from(document.querySelectorAll("footer a"));
        const findPrivacy = (a) => {
          const txt = (a.textContent || "").toLowerCase();
          return txt.includes("polityka") && txt.includes("prywatno");
        };
        const privacy = anchors.find(findPrivacy);
        if (privacy) {
          privacy.setAttribute("href", url);
          privacy.setAttribute("target", "_blank");
          privacy.setAttribute("rel", "noopener noreferrer");
          privacy.addEventListener("click", (e) => {
            // Fallback in case some global handler prevents default
            if (
              !privacy.getAttribute("href") ||
              privacy.getAttribute("href") === "#"
            ) {
              e.preventDefault();
              window.open(url, "_blank", "noopener");
            }
          });
        }
        // Wire Cookies link to open CookieConsent preferences
        const ccLink = document.querySelector("footer a[data-cc-open]");
        if (ccLink) {
          ccLink.addEventListener("click", (e) => {
            e.preventDefault();
            if (
              window.CookieConsent &&
              typeof window.CookieConsent.showPreferences === "function"
            ) {
              window.CookieConsent.showPreferences();
            }
          });
        }
      } catch {}
    };
    if (document.readyState === "loading")
      document.addEventListener("DOMContentLoaded", run);
    else run();
  })();
</script>
